// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 조직 및 설치 정보
// ============================================

model Organization {
  id             String   @id @default(cuid())
  githubId       BigInt   @unique
  login          String   @unique
  name           String?
  avatarUrl      String?
  installationId Int?
  settings       Json? // 핵심모듈 경로, 가중치 등
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  repos    Repository[]
  members  OrganizationMember[]
  syncJobs CommitSyncJob[]
}

model OrganizationMember {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  role      OrgRole  @default(MEMBER)
  createdAt DateTime @default(now())

  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([userId])
}

enum OrgRole {
  ADMIN
  MEMBER
}

// ============================================
// 사용자 (로그인 사용자)
// ============================================

model User {
  id          String   @id @default(cuid())
  githubId    BigInt   @unique
  login       String   @unique
  name        String?
  email       String?
  avatarUrl   String?
  accessToken String? // GitHub API 호출용 (암호화 필요)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizations OrganizationMember[]
  syncJobs      CommitSyncJob[]      @relation("SyncCreatedBy")
}

// ============================================
// 저장소
// ============================================

model Repository {
  id            String   @id @default(cuid())
  orgId         String
  githubId      BigInt
  fullName      String   @unique
  name          String
  defaultBranch String   @default("main")
  isArchived    Boolean  @default(false)
  isPrivate     Boolean  @default(true)
  language      String?
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  org          Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  commits      Commit[]
  pullRequests PullRequest[]

  @@index([orgId])
}

// ============================================
// GitHub 사용자 (커밋 작성자 매핑)
// ============================================

model GitHubUser {
  id        String   @id @default(cuid())
  login     String   @unique
  name      String?
  email     String?
  avatarUrl String?
  aliases   String[] // 이메일 alias 목록
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  commits      Commit[]
  pullRequests PullRequest[]
}

// ============================================
// 커밋
// ============================================

model Commit {
  id           String   @id @default(cuid())
  repoId       String
  sha          String
  authorLogin  String
  authorEmail  String?
  message      String   @db.Text
  committedAt  DateTime
  additions    Int      @default(0)
  deletions    Int      @default(0)
  filesChanged Int      @default(0)

  repo    Repository          @relation(fields: [repoId], references: [id], onDelete: Cascade)
  author  GitHubUser          @relation(fields: [authorLogin], references: [login])
  files   CommitFile[]
  prLinks PullRequestCommit[]

  @@unique([repoId, sha])
  @@index([authorLogin, committedAt])
  @@index([repoId, committedAt])
}

model CommitFile {
  id        String @id @default(cuid())
  commitId  String
  path      String
  additions Int    @default(0)
  deletions Int    @default(0)
  status    String // added, modified, deleted, renamed

  commit Commit @relation(fields: [commitId], references: [id], onDelete: Cascade)

  @@index([commitId])
  @@index([path])
}

// ============================================
// 커밋 동기화
// ============================================

model CommitSyncJob {
  id          String     @id @default(cuid())
  orgId       String
  year        Int
  status      SyncStatus @default(PENDING)
  progress    Json? // { totalRepos, completedRepos, failedRepos, totalCommits }
  error       String?    @db.Text
  startedAt   DateTime?
  finishedAt  DateTime?
  createdAt   DateTime   @default(now())
  createdById String?

  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy User?        @relation("SyncCreatedBy", fields: [createdById], references: [id])

  @@unique([orgId, year])
  @@index([status])
  @@index([orgId])
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ============================================
// Pull Request
// ============================================

model PullRequest {
  id          String    @id @default(cuid())
  repoId      String
  githubId    BigInt
  number      Int
  title       String
  body        String?   @db.Text
  state       String // open, closed, merged
  authorLogin String
  baseBranch  String
  headBranch  String
  mergedAt    DateTime?
  closedAt    DateTime?
  createdAt   DateTime
  updatedAt   DateTime

  repo    Repository          @relation(fields: [repoId], references: [id], onDelete: Cascade)
  author  GitHubUser          @relation(fields: [authorLogin], references: [login])
  commits PullRequestCommit[]

  @@unique([repoId, number])
  @@index([authorLogin])
  @@index([repoId, state])
  @@index([repoId, createdAt])
}

model PullRequestCommit {
  prId     String
  commitId String

  pr     PullRequest @relation(fields: [prId], references: [id], onDelete: Cascade)
  commit Commit      @relation(fields: [commitId], references: [id], onDelete: Cascade)

  @@id([prId, commitId])
  @@index([commitId])
}
