// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 조직 및 설치 정보
// ============================================

model Organization {
  id             String   @id @default(cuid())
  githubId       BigInt   @unique
  login          String   @unique
  name           String?
  avatarUrl      String?
  installationId Int?
  settings       Json? // 핵심모듈 경로, 가중치 등
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  repos        Repository[]
  members      OrganizationMember[]
  syncJobs     CommitSyncJob[]
  analysisRuns AnalysisRun[]
}

model OrganizationMember {
  id          String   @id @default(cuid())
  orgId       String
  githubLogin String // GitHub 로그인 (필수 - 조직 멤버 식별)
  userId      String? // User와 연결 (로그인한 경우에만)
  role        OrgRole  @default(MEMBER)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, githubLogin]) // GitHub 로그인으로 유일성 보장
  @@index([userId])
  @@index([githubLogin])
}

enum OrgRole {
  ADMIN
  MEMBER
}

// ============================================
// 사용자 (로그인 사용자)
// ============================================

model User {
  id          String   @id @default(cuid())
  githubId    BigInt   @unique
  login       String   @unique
  name        String?
  email       String?
  avatarUrl   String?
  accessToken String? // GitHub API 호출용 (암호화 필요)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizations OrganizationMember[]
  syncJobs      CommitSyncJob[]      @relation("SyncCreatedBy")
}

// ============================================
// 저장소
// ============================================

model Repository {
  id            String   @id @default(cuid())
  orgId         String
  githubId      BigInt
  fullName      String   @unique
  name          String
  defaultBranch String   @default("main")
  isArchived    Boolean  @default(false)
  isPrivate     Boolean  @default(true)
  language      String?
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  org          Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  commits      Commit[]
  pullRequests PullRequest[]
  workUnits    WorkUnit[]

  @@index([orgId])
}

// ============================================
// GitHub 사용자 (커밋 작성자 매핑)
// ============================================

model GitHubUser {
  id        String   @id @default(cuid())
  login     String   @unique
  name      String?
  email     String?
  avatarUrl String?
  aliases   String[] // 이메일 alias 목록
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  commits      Commit[]
  pullRequests PullRequest[]
}

// ============================================
// 커밋
// ============================================

model Commit {
  id           String   @id @default(cuid())
  repoId       String
  sha          String
  authorLogin  String
  authorEmail  String?
  message      String   @db.Text
  committedAt  DateTime
  additions    Int      @default(0)
  deletions    Int      @default(0)
  filesChanged Int      @default(0)

  repo          Repository          @relation(fields: [repoId], references: [id], onDelete: Cascade)
  author        GitHubUser          @relation(fields: [authorLogin], references: [login])
  files         CommitFile[]
  prLinks       PullRequestCommit[]
  diff          CommitDiff?
  workUnitLinks WorkUnitCommit[]

  @@unique([repoId, sha])
  @@index([authorLogin, committedAt])
  @@index([repoId, committedAt])
}

model CommitFile {
  id        String @id @default(cuid())
  commitId  String
  path      String
  additions Int    @default(0)
  deletions Int    @default(0)
  status    String // added, modified, deleted, renamed

  commit Commit @relation(fields: [commitId], references: [id], onDelete: Cascade)

  @@index([commitId])
  @@index([path])
}

// ============================================
// 커밋 동기화
// ============================================

model CommitSyncJob {
  id          String     @id @default(cuid())
  orgId       String
  year        Int
  status      SyncStatus @default(PENDING)
  progress    Json? // { totalRepos, completedRepos, failedRepos, totalCommits }
  error       String?    @db.Text
  startedAt   DateTime?
  finishedAt  DateTime?
  createdAt   DateTime   @default(now())
  createdById String?

  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy User?        @relation("SyncCreatedBy", fields: [createdById], references: [id])

  @@unique([orgId, year])
  @@index([status])
  @@index([orgId])
}

enum SyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ============================================
// Pull Request
// ============================================

model PullRequest {
  id          String    @id @default(cuid())
  repoId      String
  githubId    BigInt
  number      Int
  title       String
  body        String?   @db.Text
  state       String // open, closed, merged
  authorLogin String
  baseBranch  String
  headBranch  String
  mergedAt    DateTime?
  closedAt    DateTime?
  createdAt   DateTime
  updatedAt   DateTime

  repo    Repository          @relation(fields: [repoId], references: [id], onDelete: Cascade)
  author  GitHubUser          @relation(fields: [authorLogin], references: [login])
  commits PullRequestCommit[]

  @@unique([repoId, number])
  @@index([authorLogin])
  @@index([repoId, state])
  @@index([repoId, createdAt])
}

model PullRequestCommit {
  prId     String
  commitId String

  pr     PullRequest @relation(fields: [prId], references: [id], onDelete: Cascade)
  commit Commit      @relation(fields: [commitId], references: [id], onDelete: Cascade)

  @@id([prId, commitId])
  @@index([commitId])
}

// ============================================
// 분석 실행
// ============================================

model AnalysisRun {
  id          String         @id @default(cuid())
  orgId       String
  year        Int
  userLogin   String // 분석 대상 기여자 (단일)
  status      AnalysisStatus @default(PENDING)
  phase       String? // METRICS, CLUSTERING, SAMPLING, ANALYZING, DONE
  progress    Json? // { currentStep, totalSteps, message }
  error       String?        @db.Text
  startedAt   DateTime?
  finishedAt  DateTime?
  createdAt   DateTime       @default(now())
  createdById String?

  org       Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  workUnits WorkUnit[]
  reports   YearlyReport[]

  @@unique([orgId, year, userLogin]) // 기여자별 독립 분석
  @@index([status])
  @@index([orgId])
  @@index([userLogin])
}

enum AnalysisStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// ============================================
// WorkUnit: 관련 커밋을 묶은 작업 단위
// ============================================

model WorkUnit {
  id            String   @id @default(cuid())
  analysisRunId String
  userLogin     String
  repoId        String
  title         String? // AI가 생성한 작업 제목
  summary       String?  @db.Text // AI가 생성한 작업 요약
  workType      String? // feature, bugfix, refactor, docs, test, chore
  impactScore   Float    @default(0)
  impactFactors Json? // 점수 산출 근거
  isSampled     Boolean  @default(false)
  startDate     DateTime
  endDate       DateTime
  createdAt     DateTime @default(now())

  analysisRun AnalysisRun      @relation(fields: [analysisRunId], references: [id], onDelete: Cascade)
  repo        Repository       @relation(fields: [repoId], references: [id], onDelete: Cascade)
  commits     WorkUnitCommit[]
  aiReviews   AiReview[]

  @@index([analysisRunId, userLogin])
  @@index([repoId])
  @@index([impactScore(sort: Desc)])
}

model WorkUnitCommit {
  workUnitId String
  commitId   String

  workUnit WorkUnit @relation(fields: [workUnitId], references: [id], onDelete: Cascade)
  commit   Commit   @relation(fields: [commitId], references: [id], onDelete: Cascade)

  @@id([workUnitId, commitId])
  @@index([commitId])
}

// ============================================
// AI 리뷰 결과
// ============================================

model AiReview {
  id            String   @id @default(cuid())
  workUnitId    String? // WorkUnit 단위 리뷰
  reportId      String? // YearlyReport 단위 리뷰 (종합)
  stage         Int // 0: 샘플링, 1: 코드품질, 2: 패턴, 3: 성장, 4: 종합
  promptVersion String   @default("v1.0.0")
  result        Json // 구조화된 분석 결과
  tokenUsage    Json? // { inputTokens, outputTokens, totalCost }
  createdAt     DateTime @default(now())

  workUnit WorkUnit?     @relation(fields: [workUnitId], references: [id], onDelete: Cascade)
  report   YearlyReport? @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([workUnitId])
  @@index([reportId])
  @@index([stage])
}

// ============================================
// 샘플링된 커밋의 Diff
// ============================================

model CommitDiff {
  id        String   @id @default(cuid())
  commitId  String   @unique
  diff      String   @db.Text // 전체 diff (파일별)
  summary   String?  @db.Text // AI가 생성한 요약
  createdAt DateTime @default(now())

  commit Commit @relation(fields: [commitId], references: [id], onDelete: Cascade)
}

// ============================================
// 연간 평가 리포트
// ============================================

model YearlyReport {
  id             String    @id @default(cuid())
  analysisRunId  String
  userLogin      String
  metrics        Json // 정량 지표 (DeveloperMetrics)
  aiInsights     Json? // AI 분석 결과 (Stage4Result)
  overallScore   Json? // 종합 점수 { productivity, codeQuality, diversity, collaboration, growth }
  charts         Json? // 차트 데이터
  managerComment String?   @db.Text
  confirmedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  analysisRun AnalysisRun @relation(fields: [analysisRunId], references: [id], onDelete: Cascade)
  aiReviews   AiReview[]

  @@unique([analysisRunId, userLogin])
  @@index([analysisRunId])
  @@index([userLogin])
}
